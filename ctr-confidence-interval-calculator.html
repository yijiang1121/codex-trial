<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CTR Confidence Interval Calculator</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
  <body class="page-ctr">
    <main>
      <h1>CTR Confidence Interval Calculator</h1>
      <p class="description">
        Quickly estimate the click-through rate (CTR) and its confidence interval for your campaigns.
      Enter the total number of engagements (clicks) and impressions, adjust the confidence level if needed,
      and review the resulting metrics instantly.
    </p>

    <form id="ctr-form" novalidate>
      <div class="field">
        <label for="engagement">Engagements (clicks)</label>
        <input id="engagement" name="engagement" type="number" min="0" step="1" placeholder="e.g. 420" required>
      </div>

      <div class="field">
        <label for="impressions">Impressions</label>
        <input id="impressions" name="impressions" type="number" min="1" step="1" placeholder="e.g. 12000" required>
      </div>

      <div class="field">
        <label for="confidence">Confidence level</label>
        <select id="confidence" name="confidence">
          <option value="90">90%</option>
          <option value="95" selected>95%</option>
          <option value="98">98%</option>
          <option value="99">99%</option>
        </select>
      </div>

      <button type="submit">Calculate</button>
      <div id="error" class="error" hidden></div>
    </form>

    <section class="results" aria-live="polite" aria-atomic="true">
      <h2>Results</h2>
      <div class="metric-grid">
        <article class="metric-card">
          <h3>Click-Through Rate</h3>
          <p id="ctr">–</p>
        </article>
        <article class="metric-card">
          <h3>Standard Error</h3>
          <p id="standard-error">–</p>
        </article>
        <article class="metric-card">
          <h3>Margin of Error</h3>
          <p id="margin-of-error">–</p>
        </article>
      </div>
      <article class="metric-card">
        <h3>Confidence Interval</h3>
        <p id="confidence-interval">–</p>
      </article>
    </section>

    <footer>
      Calculations use a normal approximation (Wald interval). Ensure impressions are sufficiently large for accurate results.
    </footer>
  </main>

  <script>
    const zScores = {
      90: 1.6448536269514722,
      95: 1.959963984540054,
      98: 2.3263478740408408,
      99: 2.5758293035489004
    };

    const ctrForm = document.getElementById('ctr-form');
    const engagementInput = document.getElementById('engagement');
    const impressionsInput = document.getElementById('impressions');
    const confidenceInput = document.getElementById('confidence');
    const ctrOutput = document.getElementById('ctr');
    const standardErrorOutput = document.getElementById('standard-error');
    const marginOutput = document.getElementById('margin-of-error');
    const intervalOutput = document.getElementById('confidence-interval');
    const errorBox = document.getElementById('error');

    function formatPercent(value) {
      return (value * 100).toLocaleString(undefined, {
        maximumFractionDigits: 2,
        minimumFractionDigits: 2
      }) + '%';
    }

    function formatDecimal(value) {
      return value.toLocaleString(undefined, {
        maximumFractionDigits: 4,
        minimumFractionDigits: 4
      });
    }

    function showError(message) {
      errorBox.textContent = message;
      errorBox.hidden = false;
    }

    function clearError() {
      errorBox.hidden = true;
      errorBox.textContent = '';
    }

    function updateResults({ ctr, standardError, margin, lowerBound, upperBound }) {
      ctrOutput.textContent = formatPercent(ctr);
      standardErrorOutput.textContent = formatDecimal(standardError);
      marginOutput.textContent = formatPercent(margin);
      intervalOutput.textContent = `${formatPercent(lowerBound)} – ${formatPercent(upperBound)}`;
    }

    function calculateMetrics(engagements, impressions, zScore) {
      const ctr = engagements / impressions;
      const variance = ctr * (1 - ctr) / impressions;
      const standardError = Math.sqrt(variance);
      const margin = zScore * standardError;
      const lowerBound = Math.max(ctr - margin, 0);
      const upperBound = Math.min(ctr + margin, 1);

      return { ctr, standardError, margin, lowerBound, upperBound };
    }

    ctrForm.addEventListener('submit', (event) => {
      event.preventDefault();

      const engagements = Number(engagementInput.value);
      const impressions = Number(impressionsInput.value);
      const confidenceLevel = Number(confidenceInput.value);

      clearError();

      if (!Number.isFinite(engagements) || engagements < 0) {
        showError('Please enter a non-negative number of engagements.');
        return;
      }

      if (!Number.isFinite(impressions) || impressions <= 0) {
        showError('Impressions must be a positive number.');
        return;
      }

      if (engagements > impressions) {
        showError('Engagements cannot exceed impressions.');
        return;
      }

      const zScore = zScores[confidenceLevel];
      if (!zScore) {
        showError('Unsupported confidence level.');
        return;
      }

      const metrics = calculateMetrics(engagements, impressions, zScore);
      updateResults(metrics);
    });

    // Provide sample default values to demonstrate the calculator.
    engagementInput.value = '420';
    impressionsInput.value = '12000';
    ctrForm.dispatchEvent(new Event('submit'));
  </script>
</body>
</html>
